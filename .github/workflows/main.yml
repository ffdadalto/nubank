name: Deploy Node App (Self-Hosted + IIS)

on:
    push:
        branches: ["main"]

concurrency:
    group: deploy-nubank
    cancel-in-progress: true

jobs:
    deploy:
        name: Build + Deploy on Windows Server (IIS)
        runs-on: [self-hosted, windows, x64]

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js 22
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"

            - name: Install dependencies
              shell: powershell
              run: npm ci

            - name: Build
              shell: powershell
              run: npm run build

            - name: Validate build output
              shell: powershell
              run: |
                  if (!(Test-Path ".\dist")) { throw "Pasta .\dist não encontrada. Confere a saída do build." }

            - name: IIS debug (whoami + list sites + app pools)
              shell: powershell
              run: |
                  whoami
                  $appcmd = "$env:windir\System32\inetsrv\appcmd.exe"
                  if (!(Test-Path $appcmd)) { throw "appcmd não encontrado em $appcmd. IIS está instalado nesse servidor?" }
                  & $appcmd list site
                  & $appcmd list apppool

            - name: Recycle App Pool (only if exists)
              shell: powershell
              run: |
                  $poolName = "Nubank"
                  $appcmd = "$env:windir\System32\inetsrv\appcmd.exe"

                  $poolLine = & $appcmd list apppool "$poolName" 2>$null
                  if (-not $poolLine) {
                    Write-Host "App Pool '$poolName' não encontrado. Vou pular recycle."
                    exit 0
                  }

                  Write-Host "Reciclando App Pool '$poolName'..."
                  & $appcmd recycle apppool "$poolName"

            - name: Copy dist to IIS folder
              shell: powershell
              run: |
                  $source = (Resolve-Path ".\dist").Path
                  $target = "C:\inetpub\wwwroot\Nubank"

                  New-Item -ItemType Directory -Force -Path $target | Out-Null

                  # limpa resquício do deploy antigo via FTP
                  Remove-Item "$target\.ftp-deploy-sync-state.json" -Force -ErrorAction SilentlyContinue

                  robocopy $source $target /MIR /R:2 /W:2 /NFL /NDL /NP

                  $rc = $LASTEXITCODE
                  if ($rc -ge 8) { throw "Robocopy falhou (exit code $rc)" }

                  exit 0

            - name: Ensure site is Started (only if stopped)
              shell: powershell
              run: |
                  $siteName = "Nubank"
                  $appcmd = "$env:windir\System32\inetsrv\appcmd.exe"

                  $siteLine = & $appcmd list site "$siteName" 2>$null
                  if (-not $siteLine) { throw "Site IIS '$siteName' não encontrado." }

                  if ($siteLine -match "state:Stopped") {
                    Write-Host "Site '$siteName' está Stopped. Iniciando..."
                    & $appcmd start site "$siteName"
                  } else {
                    Write-Host "Site '$siteName' já está Started (ou em transição)."
                  }
