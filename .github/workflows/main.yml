name: Deploy Node App (Self-Hosted + IIS)

on:
    push:
        branches: ["main"]

concurrency:
    group: deploy-nubank
    cancel-in-progress: true

jobs:
    deploy:
        runs-on: [self-hosted, windows, x64]

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js 22
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"

            - name: Install dependencies
              shell: powershell
              run: npm ci

            - name: Build
              shell: powershell
              run: npm run build

            - name: Validate build output
              shell: powershell
              run: |
                  if (!(Test-Path ".\dist")) { throw "Pasta .\dist não encontrada. Confere a saída do build." }

            - name: IIS debug (whoami + list sites)
              shell: powershell
              run: |
                  whoami
                  $appcmd = "$env:windir\System32\inetsrv\appcmd.exe"
                  if (!(Test-Path $appcmd)) { throw "appcmd não encontrado em $appcmd. IIS está instalado nesse servidor?" }
                  & $appcmd list site

            - name: Stop IIS site (Nubank)
              shell: powershell
              run: |
                  $appcmd = "$env:windir\System32\inetsrv\appcmd.exe"
                  & $appcmd stop site "Nubank"

            - name: Copy dist to IIS folder
              shell: powershell
              run: |
                  $source = (Resolve-Path ".\dist").Path
                  $target = "C:\inetpub\wwwroot\Nubank"  # <<< AJUSTE se seu Physical Path for outro

                  New-Item -ItemType Directory -Force -Path $target | Out-Null

                  robocopy $source $target /MIR /R:2 /W:2 /NFL /NDL /NP
                  if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }

            - name: Start IIS site (Nubank)
              shell: powershell
              run: |
                  $appcmd = "$env:windir\System32\inetsrv\appcmd.exe"
                  & $appcmd start site "Nubank"
