name: Deploy Node App (Self-Hosted + IIS)

on:
    push:
        branches: ["main"]

concurrency:
    group: deploy-nubank
    cancel-in-progress: true

jobs:
    deploy:
        name: Build + Deploy on Windows Server (IIS)
        runs-on: [self-hosted, windows, x64]

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js 22
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"

            - name: Install dependencies
              shell: pwsh
              run: npm ci

            - name: Build
              shell: pwsh
              run: npm run build

            - name: Validate build output
              shell: pwsh
              run: |
                  if (!(Test-Path ".\dist")) { throw "Pasta .\dist não encontrada. Confere seu build (vite/webpack) e a saída." }

            - name: Stop IIS site
              shell: pwsh
              run: |
                  Import-Module WebAdministration
                  $siteName = "Nubank"  # <<< NOME EXATO do site no IIS

                  if (!(Test-Path "IIS:\Sites\$siteName")) {
                    throw "Site IIS '$siteName' não encontrado. Confere o nome no IIS."
                  }

                  Stop-WebSite -Name $siteName

            - name: Copy dist to IIS folder
              shell: pwsh
              run: |
                  $source = (Resolve-Path ".\dist").Path
                  $target = "C:\inetpub\wwwroot\Nubank"  # <<< Physical Path do site no IIS

                  New-Item -ItemType Directory -Force -Path $target | Out-Null

                  robocopy $source $target /MIR /R:2 /W:2 /NFL /NDL /NP
                  if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }

            - name: Start IIS site
              shell: pwsh
              run: |
                  Import-Module WebAdministration
                  Start-WebSite -Name "Nubank"
